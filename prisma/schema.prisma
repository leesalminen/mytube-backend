generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  npub          String         @id
  createdAt     DateTime       @default(now())
  entitlements  Entitlement[]
  usage         Usage?
  applePurchases ApplePurchase[]
  googlePurchases GooglePurchase[]
  uploads       Upload[]
}

model Entitlement {
  id             String    @id @default(cuid())
  npub           String
  platform       String    // ios | android | web
  productId      String
  originalTxId   String?   // Apple
  purchaseToken  String?   // Google
  status         String    // active | grace | paused | canceled | expired
  expiresAt      DateTime
  quotaBytes     BigInt
  egressBytesMon BigInt    @default(0)
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [npub], references: [npub])

  @@index([npub, platform])
  @@unique([npub, productId])
}

model Usage {
  npub           String   @id
  storedBytes    BigInt   @default(0)
  egressBytesMon BigInt   @default(0)
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [npub], references: [npub])
}

model Upload {
  id          String   @id @default(cuid())
  npub        String
  objectKey   String   @unique
  status      String   // pending | uploaded | indexed
  sizeBytes   BigInt
  contentType String
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [npub], references: [npub])

  @@index([npub])
}

model ApplePurchase {
  originalTxId    String  @id
  npub            String
  appAccountToken String?
  createdAt       DateTime @default(now())
  user            User    @relation(fields: [npub], references: [npub])
}

model GooglePurchase {
  purchaseToken   String  @id
  npub            String
  packageName     String
  subscriptionId  String
  createdAt       DateTime @default(now())
  user            User    @relation(fields: [npub], references: [npub])
}
